### Лекция по теме "Средства командной работы"

- 00:07:05 - доработал модули Yandex
- 00:07:23 - в Yandex.Cloud через ресурс менеджер можно создать папки (для автоматзаци задач создания ресурсов с Terraform) и получить ее ID этой папки. 
- 00:07:40 - в провайдере Yandex для Terraform это все находилось не в VPC, а в отдельном месте. Для динамческого созданя ресурсов в Яндексе. Прмеры лежать здесь: [Terraform](https://gitlab.com/k11s-os/infrastructure-as-code/-/tree/main/) 
- 00:11:15 - про Ansible Tower (бесплатный)  и Ansible OWX (платный) - для сохраненя выхлопа, когда работает Ansible
- 00:11:50 - для Terraform тоже есть возможность сохранить выхлоп
- 00:12:00 - про технологию работы с PR (pooll request). Есть ветка main, в которую запрещены коммиты. У нас есть gitflow. Мы отпочковываемся в новую ветку, делаем там изменения и коммиты, затем создаем PR (pooll request). Мы можем посмотреть что у нас там применится и если этот PR (pooll request) аппрувят, то мы применяем изменения на инфраструктуру. Для этого мержим в ветку мастер. Таким образом все наши измененя идут из ветки мастер.
- 

Сергей
Андрюнин
#### Средства командной работы
2
Сергей Андрюнин
DevOps-инженер
RTLabs
1. Средства командной работы
2. Terraform cloud
3. Атлантис
4. Remote state
5. Модули
6. Домашнее задание
План занятия
3

#### Средства командной работы
4

#### Основные инструменты
5
● Terraform Cloud / Terraform Enterprise
○ Есть бесплатные тарифы, но полный функционал платный.
○ Хостится на сервера hashicorp.
● Atlantis
○ Решение с открытым исходным кодом.
○ Запускается на ваших серверах.

#### Зачем использовать эти инструменты?
6
● Прозрачность процессов
○ Если каждый запускает локально – не понятно что сейчас
задеплоено.
○ Кто-то мог забыть закоммитить изменения.
○ Есть логи всех plan и apply.

### Каждый может сделать PR в инфраструктуру
7
● Каждый может сделать PR и посмотреть plan своих изменений.
○ Это существенно ускоряет процессы: вместо того чтобы
ставить задачу на простое изменение, разработчик просто
делает PR.
● Все секретные данные будут скрыты в пределах этой системы.

### Более качественный процесс ревью PR
8
● Можно проверить код.
● Сразу виден результат работы terraform plan.

### Стандартизация рабочих процессов
9
● Система блокирует рабочее пространство (workspace) до
применения изменений или ручного снятия блокировки.
● Помимо стандартных команд plan и apply можно добавить
дополнительные инструкции.

### Terraform Cloud
### Terraform Cloud
Поддерживает несколько типов:
● На основе системы контроля версий,
● Просто remote backend запускаемый вручную,
● На основе API (много возможностей, но сложно использовать). - 00:16:10 для создания ресурсов через веб-интерфейс

### Terraform Cloud
Особенности:
● Поддерживаем remote state.
● Необходимо обеспечить доступ к api своих сервисов.
● Поддерживается командой терраформа.
● Есть бесплатный тарифный план.
● Хороший UI с возможностью ревью изменений.
● Интеграция с slack.
● Можно задавать переменные для разных окружений.

### Атлантис
### Автоматизация pull request
16
Сайт: https://www.runatlantis.io/
Совместимо с:
● GitHub
● GitLab
● Bitbucket
● Azure DevOps

### Особенности
17
● Бесплатное решение.
● Поддерживает множество популярных хранилищ
репозиториев.
● Достаточно где угодно запустить докер контейнер с набором
переменных окружения

### Шаг 1
18
Открывает pull request в репозитории с кодом terraform

### Шаг 2
19
Атлантис
автоматически
запускает terraform
plan и оставляет
комментарий к PR.

### Шаг 3
20
Кто-то из вашей команды просматривает план и одобряет PR

### Шаг 4
21
Вы оставляете комментарий atlantis apply

### Шаг 5
22
Атлантис исполняет terraform apply и оставляет комментарий об этом

### Шаг 6
23
Атлантис автоматически мержит PR

### Настройка сервера
24
Давайте посмотрим пример конфига:
https://www.runatlantis.io/docs/server-side-repo-config.html
● Проверка апрува PR.
● Проверка "Mergeable" статуса.
● Разрешения изменять настройки внутри репозитория.
● Изменения стандартного воркфлоу атлантиса.

- 00:25:40 - описание пирмера настройки серверного конфига, показаны workflow_hooks,  шаги workflow

### Настройка клиента
25
Давайте посмотрим пример конфига:
https://www.runatlantis.io/docs/repo-level-atlantis-yaml.html
● Настройка авто планирования.
● Триггеры авто планирования.
● Установка конкретной версии терраформа.
● Разные воркспейсы.
● Апрув для конкретных воркспейсов.

- 00:27:40 - описание пирмера настройки клиентского конфига,


### Remote state

### Чтение удаленного состояния проекта  - 00:29:20
27
Получает данные об удаленном состоянии проекта
Terraform.
Это позволяет использовать outputs параметры одного
проекта в качестве входных данных для других проектов.

- 00:29:20 - !!! про Remote state (удаленное состояние). файлы `tf.state` описывают удаленное состояне текущей иинфраструктцры и перед тем, как сделать изменения терраформ забирает удаленное состояние, сравнивает его и показывает в итоге измененный выхлоп. Это позволяет использовать outputs параметры одного проекта в качестве входных данных для других проектов. Можно разбить наш проект на несколько мелких частей. На пример Core Team - основная команда, которая занимается только облаком. Иногда их называют Shared ITб инфраструктурщки.


### Пример remote_state - 00:32:20
28
```tf
data "terraform_remote_state" "vpc" {
backend = "remote"
config = {
organization = "hashicorp"
workspaces = {
name = "vpc-prod"
}
}
}
resource "aws_instance" "foo" {
# ...
subnet_id = data.terraform_remote_state.vpc.outputs.subnet_id
```
- 00:33:00 - вы создали VPC и чтобы раздать ID на всё, чтобы разработчк мог сам собирать  разбрать ВМ для него нужны ID облака, подсети, папки, и др. 
Мы говорим разрабу как это все можно забрать и он забрает их  все отлично. 




- 00:33:00 - про модули Terraform. Это аналог подключаемых бибилиотек в программах или ЯП.
- 00:39:00 - про создание папок для модулей Terraform
- 00:40:00 - показаны переменные для разных workspace - prod, stage

- 00:49:00 - показан файл main.tf с настройкам
- 00:50:40 - настройки ВМ
- 00:51:20 - terraform workspace show
- создаем днамическ папку
- параметры создания инстанса
- 00:55:00 - как передать folder_id в переменные


