# Лекция по теме "7.1. Инфраструктура как код"


Сергей
АндрюнинСергей Андрюнин
DevOps-инженер
RTLabs
Сергей Андрюнин

## Пора учить RUST

### 2План занятия
1. DevOps в контексте IaC
2. Инфраструктура как код (IaC)
3. Выбор инструментов
4. Совместное использование инструментов
5. Резюме
6. Terraform
7. Итоги
8. Домашнее задание

### 3DevOps в контексте IaC
#### 4До эры DevOps
CODE
Development
Operations
#### 5Появление DevOps
CODE
Development
Operations

#### 6DevOps на этом занятии
DevOps - не название команды, должности или какой-то
определенной технологии. Это набор процессов, идей и методик.
Каждый понимает под DevOps что-то свое, но для этого раздела:
Цель DevOps:
значительно повысить эффективность доставки ПО.

### Инфраструктура как код (IaC)
#### Инфраструктура как код
Идея, стоящая за IaC (infrastructure as code), заключается в том, что для определения, развертывания, обновления и удаления инфраструктуры нужно писать и выполнять код.
[Рекомендуемая книга](https://www.labirint.ru/books/746712/)

#### 9Специализированные скрипты
Самый простой и понятный способ что-либо автоматизировать — написать
для этого специальный скрипт.
```bash
#!/bin/bash
# Обновляем кэш apt-get sudo apt-get update
apt-get update
# Устанавливаем PHP и Apache
apt-get install -y php apache2
# Копируем код из репозитория
git clone https://github.com/your_account/php-app.git /var/www/html/app
# Запускаем Apache
service apache2 start
```

#### 10Средства управления конфигурацией
Chef, Puppet, Ansible и SaltStack являются средствам управления конфигурацией.
Это означает, что они предназначены для установки и администрирования
программного обеспечения на существующих серверах.
Тот же скрипт на Ansible:
```bash
- name: Update the apt-get cache
apt:
update_cache: yes
- name: Install PHP
apt:
name: php
- name: Install Apache
apt:
name: apache2
- name: Copy the code from the repository
git: repo=https://github.com/your_account/php-app.git dest=/var/www/html/app
- name: Start Apache
service: name=apache2 state=started enabled=yes
```

#### 11Ansible vs bash скрипт
Преимущества:
● Стандартизированное оформление кода.
● Идемпотентность
(свойство объекта или операции при повторном применении
операции к объекту давать тот же результат, что и при первом).
● Распределенность.
изображение взято из книги “Terraform инфраструктура на уровне кода” Евгений Брикман

#### 12Средства шаблонизации серверов
Такие как Docker, Packer и Vagrant.
Вместо того чтобы вводить кучу серверов и настраивать их,
запуская на каждом один и тот же код, средства
шаблонизации создают образ сервера, содержащий
полностью самодостаточный «снимок» операционной
системы (ОС), программного обеспечения, файлов и любых
других важных деталей.
Конфиг packer:
```bash
"provisioners": [{
"type": "shell",
"inline": [
"apt-get update",
"apt-get install -y php",
"apt-get install -y apache2",
]
}]
```

#### 13
изображение взято из книги “Terraform инфраструктура на уровне кода” Евгений БрикманСредства для работы с образами
1. Виртуальные машины: эмулируют весь компьютер включая
аппаратное обеспечение.
a. Для виртуализации оборудования запускается гипервизор.
b. Любой образ ВМ видит только виртуальное оборудование,
поэтому он полностью изолирован от физического
компьютера и других ВМ.
c. Много накладных расходов на виртуализацию.
d. Образы можно описывать при помощи кода, например,
используя Packer и Vagrant.

#### 14Средства для работы с образами
2. Контейнеры: эмулируют пользовательское пространства ОС.
a. Для изоляции процессов, памяти, точек монтирования и
сети запускается среда выполнения контейнеров, такая как
Docker, CoreOs rkt или cri-o.
b. Каждый контейнер может видеть только собственное
пользовательское пространство.
c. Все контейнеры запущенные на одном сервере
одновременно пользуются оборудованием основной ОС.
d. Контейнеры запускаются очень быстро.
e. Образы можно описывать при помощи кода, используя
Docker и CoreOs rkt.

#### 15Неизменяемая инфраструктура
Шаблонизация серверов — это ключевой аспект перехода на
неизменяемую инфраструктуру.
Если сервер уже развернут, в него больше не вносятся никакие
изменения. Если нужно что-то обновить (например, развернуть новую
версию кода), вы создаете новый образ из своего шаблона и
развертываете его на новый сервер.

#### 16Средства оркестрации
Нужно выбрать какой-то способ выполнения таких действий:
● Развертывать ВМ и контейнеры с целью эффективного
использования оборудования.
● Выкатка обновлений.
● Автовосстановление.
● Автомасштабирование.
● Балансировка нагрузки.
● Обнаружение сервисов.
Выполнение этих задач находится в сфере ответственности средств
оркестрации, таких как Kubernetes, Marathon/Mesos, Amazon Elastic
Container Service (Amazon ECS), Docker Swarm, Nomad и др.
И это все описывается тоже в виде кода!

#### 17Средства инициализации ресурсов
Средства инициализации ресурсов, такие как
Terraform, CloudFormation и OpenStack Heat,
отвечают за создание самих серверов.
Тот же самый сервер при помощи terraform:
```bash
resource "aws_instance" "app" {
instance_type = "t2.micro"
availability_zone = "us-east-2a"
ami = "ami-0c55b159cbfafe1f0"
user_data = <<-EOF
#!/bin/bash
sudo service apache2 start
EOF
}
```

#### 18
изображение взято из книги “Terraform инфраструктура на уровне кода” Евгений БрикманПреимущества инфраструктуры в виде кода
● Самообслуживание: тайные знания не сосредоточены только в
голове админа).
● Скорость и безопасность: исключается человеческих фактор при
развертывании очередного сервера.
● Документация: код IaC сам по себе хорошая документация.
● Управление версиями: код хранится в vcs.
● Проверка: тесты и код ревью.
● Повторное использование: переиспользование готовых модулей.
● Радость: больше нет рутинных действий.

### 19Выбор инструментов

#### 20Надо выбрать из:
● Управление конфигурацией или инициализация ресурсов.
● Изменяемая или неизменяемая инфраструктура.
● Процедурный или декларативный язык.
● Наличие или отсутствие центрального сервера.
● Наличие или отсутствие агента.

#### 21Управление конфигурацией или инициализация ресурсов?
● Chef, Puppet, Ansible и SaltStack управляют конфигурацией.
● CloudFormation, Terraform и OpenStack Heat инициализируют
ресурсы.
Это не совсем четкое разделение, так как средства управления
конфигурацией обычно в какой-то степени поддерживают
инициализацию ресурсов, а средства инициализации ресурсов
занимаются какого-то рода конфигурацией.
Поэтому следует выбирать тот инструмент, который лучше всего
подходит для вашего случая.

#### 22Изменяемая и неизменяемая архитектура?
● Изменяемая
○ проблема дрейфа конфигурации,
○ неочевидные расхождения между тестовыми прогонами и
продакшеном,
○ например обновление библиотеки OpenSSL приведет к
отдельному ее обновлению на каждом отдельном сервере.
● Неизменяемая
○ дает уверенность идентичности всех серверов
(тоже есть нюансы),
○ обновление OpenSSL – это создание нового образа,
○ но даже минимальное изменение ведет к пересборке
образов.

#### Процедурный или декларативный подход?
●
●
Процедурный
○ Chef и Ansible
○ код пошагово описывает как достичь желаемого результата
Декларативный
○ Terraform, CloudFormation, SaltStack, Puppet и Open Stack Heat
○ в коде описывается нужное вам конечное состояние, а средства IaC
сами разбираются с тем, как его достичь.
- ec2:
count: 10
image: ami-0c55b159cbfafe1f0
instance_type: t2.micro
resource "aws_instance" "example" {
count = 10
ami = "ami-0c55b159cbfafe1f0"
instance_type = "t2.micro"
}
#### 24Основные проблемы процедурного подхода
● Процедурный код не полностью охватывает состояние
инфраструктуры.
● Процедурный код ограничивает повторное
использование.

#### 25Основные особенности декларативного
подхода
● Отсутствие доступа к полноценному языку
программирования.
● Процедурный код ограничивает повторное
использование.

#### 26Наличие или отсутствие центрального
сервера
● Chef, Puppet и SaltStack по умолчанию требуют наличия
центрального (master) сервера для хранения состояния
вашей инфраструктуры и распространения обновлений.
● У Ansible, CloudFormation, Heat и Terraform по умолчанию
нет центрального сервера.
(но всегда есть нюансы)

#### 27Преимущества центрального сервера
● Это единое централизованное место, где вы можете
просматривать и администрировать состояние своей
инфраструктуры.
● Некоторые центральные серверы умеют работать
непрерывно, в фоновом режиме, обеспечивая
соблюдение вашей конфигурации.

#### 28Особенности центрального сервера
● Дополнительная инфраструктура. Вам нужно развернуть
дополнительный сервер или даже кластер дополнительных
серверов (для высокой доступности и масштабируемости).
● Обслуживание. Центральный сервер нуждается в
обслуживании, обновлении, резервном копировании,
мониторинге и масштабировании.
● Безопасность. Вам нужно сделать так, чтобы клиент мог
общаться с центральным сервером, а последний — со всеми
остальными серверами Это обычно требует открытия
дополнительных портов и настройки дополнительных систем
аутентификации, что увеличивает область потенциальных атак.

#### 29Наличие или отсутствие агентов
● Chef, Puppet и SaltStack требуют установки своих агентов
на каждый сервер, который вы хотите настраивать. Агент
обычно работает в фоне и отвечает за установку
последних обновлений конфигурации.
● Ansible, CloudFormation, Heat и Terraform не требуют
установки никаких дополнительных агентов.
(но всегда есть нюансы)

#### 30На самом деле не все однозначно
изображение взято из книги “Terraform инфраструктура на уровне кода” Евгений Брикман

### 31Совместное использование инструментов

#### 32Инициация ресурсов + управление
конфигурацией
изображение взято из книги “Terraform инфраструктура на уровне кода” Евгений Брикман

#### 33Инициация ресурсов + шаблонизация
серверов
изображение взято из книги “Terraform инфраструктура на уровне кода” Евгений Брикман

#### 34Инициация ресурсов + шаблонизация +
оркестрация
изображение взято из книги “Terraform инфраструктура на уровне кода” Евгений Брикман

### 35Резюме
#### 36При использовании “стандартных” способов применения
Инструмент Открытый
код Облака Тип Инф-ка Язык Агент Вед.
сервер Сообщество
Chef + Все Упр.конф. Изм-ая Процедурный + + Большое
Puppet + Все Упр.конф. Изм-ая Декларативный + + Большое
Ansible + Все Упр.конф. Изм-ая Процедурный - - Огромное
SaltStack + Все Упр.конф. Изм-ая Декларативный + + Большое
Cloud
Formation - AWS Иниц. рес. Неизм-ая Декларативный - - Маленькое
Heat + Все Иниц. рес. Неизм-ая Декларативный - - Маленькое
Terraform + Все Иниц. рес. Неизм-ая Декларативный - - Огромное

#### 37Terraform

#### 38Terraform
Терраформ это инструмент с открытым исходным
кодом от компании HashiCorp, написанный на языке
программирования Go.
Терраформ делает от вашего имени API-вызовы к
одному или нескольким провайдерам, таким как
AWS, Azure, Google Cloud, DigitalOcean, OpenStack
и множеству других.
Этот позволяет развернуть инфраструктуру прямо
с вашего ноутбука или либо любого другого
компьютера, и для всего этого не требуется никакой
дополнительной инфраструктуры.

#### 39Установка Терраформа
● Скачать с terraform.io
● Воспользоваться менеджером пакетов (apt, brew, ...)
### 40Итоги
#### 41Итоги
● Почему инфраструктуру описывают в виде кода.
● Познакомились с:
○ Средствами управления конфигурациями.
○ Средствами для работы с образами.
○ Средствами оркестрации.
○ Средствами инициализации ресурсов.
● Разобрались что такое изменяемая и неизменяемая
инфраструктура.

### 42Домашнее задание

#### 43Домашнее задание
Давайте посмотрим ваше домашнее задание.
● Вопросы по домашней работе задавайте в чате мессенджера Slack.
● Задачи можно сдавать по частям.
● Зачёт по домашней работе проставляется после того, как приняты все
задачи.

#### 44Задавайте вопросы и
пишите отзыв о лекции!
Сергей Андрюнин
Сергей Андрюнин

[Книги](https://www.ozon.ru/product/zapuskaem-ansible-mozer-rene-hoshteyn-lorin-217051387/?asb=n62qXWMUOenFdDa15atk9G6soKrSc5EZdt%252FSLQ7EJs4%253D&asb2=9PC1LgXVTGKosfohmJAezCjY3PST7mAuKIk60BqEUff3OqPmfMbt7FSFLsczxSAL&keywords=%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B0%D0%B5%D0%BC+ansible&sh=E7mIYTD2)
[2](https://www.ozon.ru/product/terraform-infrastruktura-na-urovne-koda-brikman-evgeniy-brikman-evgeniy-211432358/?asb=H06ue1PeAwopyrgIPu0mRiLQOUWUosRLONsRcqhl884%253D&asb2=DoHbK9JSL4Z5dz_7LlNsGsJvSvOJ_PSOOR5ASg_aFlDqtprKl6Yr1HbKCmT25pSm&keywords=terraform&sh=VMLafy5_)
[3](https://www.ozon.ru/product/site-reliability-engineering-nadezhnost-i-bezotkaznost-kak-v-google-beyer-betsi-dzhouns-kris-211433038/?sh=yFwYrRJs)
[4](https://www.ozon.ru/product/raspredelennye-dannye-algoritmy-raboty-sovremennyh-sistem-hraneniya-informatsii-293390709/?sh=8iBca0vs)
[5](https://dmkpress.com/catalog/computer/os/978-5-97060-965-1/)
[6](https://www.litres.ru/kris-richardson-2184/mikroservisy-patterny-razrabotki-i-refaktori-50445630/?utm_source=google&utm_medium=cpc&utm_campaign=search_dsa_ohvat_f%7C2087774395&utm_term=&utm_content=375733693660%7Bphrase_id%7D_%7Bsource%7D_%7Bsource_type%7D_%7Bregion_name%7D_9040937&param_2=987239&gclid=CjwKCAiA-9uNBhBTEiwAN3IlNI-cgsIfgYw460kCBij-ggSRaPzT8kCz4EQwbKvyDpmL_IX3MFb5hRoCYuUQAvD_BwE)
[7]()

[Проект Канико](https://github.com/GoogleContainerTools/kaniko)
