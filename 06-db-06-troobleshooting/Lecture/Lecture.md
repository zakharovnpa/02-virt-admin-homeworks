## Лекция по теме "Troubleshooting"
```bash
ГордиенкоРоман Гордиенко
Backend Developer, sdvor.com
Роман Гордиенко
```
### План занятия
```bash
1. Введение
2. MongoDB
3. Redis
4. MySQL
5. PostgreSQL
6. Elasticsearch
7. Итоги
8. Домашнее задание
```

#### Введение
##### 1. Что такое Troubleshooting
```bash
Troubleshooting - это систематический, опосредованный
определённой логикой поиск источника проблемы с целью
её решения.
Troubleshooting как поиск и устранение неисправностей
необходим для поддержания и развития сложных систем,
где проблема может иметь множество различных причин.
```
##### 2. Виды Troubleshooting
```bash
Troubleshooting БД подразделяется на:
● устранение проблем (непосредственный troubleshooting)
● performance tuning
Поиск и устранение ошибок можно разделить на следующие этапы:
● чтение логов
● профилирование
● анализ полученных данных
● устранение неисправности
● тестирование правок
```
##### 3. Категории ошибок
```bash
В БД чаще всего ошибки появляются на следующих этапах:
● установка дистрибутива (invalid installation);
● конфигурация сервера (invalid conﬁguration);
● настройка пользователей (invalid user policy);
● безопасность (invalid security policy);
● сетевые сбои (network failures).
```
##### 4. Ошибки при установке дистрибутива
```bash
Ошибки при установке дистрибутива чаще всего возникают
при:
● сбоях пакетного менеджера;
● отсутствии каких-либо прав пользователя на сервере;
● нехватки системных ресурсов;
● “битых” дистрибутивов.
Описание решений данного вида проблем чаще всего приведено
в документации на приложение, в разделах Installation или
Administration.
Решение:
- Использовать Docker.
- Почитать книгу по Docker
```
##### 5. Ошибки при конфигурировании
```bash
Ошибки конфигурации - это довольно большой слой. Примеры
типичных ошибок конфигурации:
● JVM GC некорректно обрабатывает данные ;
● Master-узел не может найти Slave-узлы ;
● Данные хранятся не в нужном разделе ;
● Сервер БД пытается принимать входящие соединения на
занятом порту ;
● Превышено количество соединений на сервер БД.
Нужно быть предельно внимательным при настройке сервера БД.
```
##### 6. Ошибки настроек пользователей и security
```bash
Ошибки настроек пользователей и security можно объединить
в единый слой. К таким ошибкам относятся:
● несанкционированный доступ пользователей до баз
данных и таблиц;
● возможность проводить CUD над данными (например в
production слоях);
● разрешение на выполнение запросов, требующих
множество вычислительных ресурсов (например в SQL -
LIKE запросы).
```
##### 7. Сетевые сбои
```bash
Сетевые сбои чаще всего происходят внезапно.
Этот тип сбоев требуется наиболее внимательно отслеживать.
Например, в CA-системах это может привести к разбиению одного
кластера на два.
Взято с сайта: informit.com
```
#### MongoDB
##### 1
```bash
MongoDB имеет достаточно подробную документацию, в
которой описаны:
● требования для развертки сервера;
● профилирование работы;
● best-practice для конфигурирования;
● методы бэкапа и восстановления данных;
● проведение мониторинга.
```
##### 2
```bash
Основные метрики мониторинга MongoDB:
● время исполнения операций;
● количество операций.
Данные метрики контролируются, посредством средств
мониторинга, поставляемых с MongoDB, либо сторонними
приложениями для мониторинга.
```
##### 3
```bash
Free monitoring - поставляемый вместе с экземпляром
MongoDB облачный инструмент мониторинга состояния БД.
Для включения Free monitoring необходимо выполнить
следующую команду в mongo-shell:
Пример ответа на данный вызов:
Взято с сайта: docs.mongodb.com
```
##### 4
```bash

```
##### 5
```bash

При установлении факта деградации производительности
системы, вычислить проблемные запросы возможно используя
следующий вызов mongo-shell:
Возвращаемый на данный запрос документ будет иметь поля:
● query (выполняемый запрос)
● active (выполняются ли сейчас операции по запросу)
● ns (имя коллекции, к которой относится запрос)
● secs_running (время выполнения запроса)
Взято с сайта: severalnines.com
```
##### 6
```bash
Узнать информацию о исполнении конкретного запроса
возможно, используя на запросе метод:
Пример вызова метода explain:
Взято с сайта: docs.mongodb.com
```

#### Redis
##### 1
```bash
Основной метрикой контроля работоспособности Redis
является latency.
Latency можно измерять, используя redis-cli:
При деградации данной величины, необходимо произвести
контроль настроек окружения.
Redis является однопоточным приложением.
Взято с сайта: redis.io
```
##### 2
```bash
Чек лист контроля основных настроек окружения Redis:
● проверка Redis на наличие блокирующих slow команд:
redis- cli SLOWLOG GET N
● проверка отключения huge_page на уровне ядра:
echo never > /sys/kernel/mm/transparent_hugepage/enabled
&& \ systemctl restart redis
● проверка задержки на уровне VM:
redis-cli --intrinsic-latency 100
```

#### MySQL
##### 1
```bash
Типовые проблемы, возникающие при использовании MySQL:
● замедление выполнения пользовательских запросов;
● неверная настройка удаленного доступа к БД;
● нехватка серверных ресурсов;
● повреждение таблиц;
● нарушение сокетного обмена с сервером MySQL.
```
##### 2
```bash
Причины замедления пользовательских запросов описаны в slow_log. Для
включения slow_log в конфигурации mysqld необходимо описать следующие
директивы:
После чего сделать рестарт процесса mysql:
Также выполнение запроса можно изучить, посредством использования SQL
директивы EXPLAIN.
Взято с сайта: digitalocean.com
```
##### 3
```bash
Пример записи из slow_log:
Взято с сайта: serverpilot.io
```
##### 4
```bash
Причины нарушения удаленного доступа чаще всего
заключаются в:
● неверно выставленных сетевых настройках сервера
БД;
● некорректных правах доступа до сущностей БД.
```
##### 5
```bash
Сетевые настройки сервера БД устанавливаются в
конфигурационном файле, посредством изменения следующей
директивы:
Из соображений безопасности не рекомендуется выставлять
внешний ip адрес или wildcard хоста в данной директиве.
Проброс соединений до сервера БД рекомендуется осуществлять
через балансировщик запросов.
```
##### 6
```bash
Синтаксис запроса просмотра привилегий на сущности БД для пользователя:
Пример запроса привилегий пользователя:
Очистка “кешей” привилегий производится следующим образом:
Взято с сайта: dev.mysql.com
```
##### 7
```bash
Нехватка серверных ресурсов в основном заключается в достижении
пределов памяти дисковых устройств, либо переполнению inodes.
Пример записей в mysql.log при данном виде проблем:
Данные характеристики являются компонентами мониторинга хоста.
Дополнительно можно произвести тонкую настройку mysql сервера,
используя конфигурационный файл для оптимальной настройки
использования памяти сервером MySQL.
Взято с сайта: digitalocean.com
```
##### 8
```bash
Основные причины повреждения таблиц с данными:
● Непредвиденная остановка сервера MySQL во время
операции записи ;
● Одновременное изменение внешним ПО записей
и сервером БД ;
● Непредвиденное отключение сервера БД ;
● Выход из строя хост-машины ;
● Программная ошибка MySQL.
```
##### 9
```bash
При возникновении повреждения таблиц с данными необходимо (пример
для MyISAM):
● остановить сервер БД
● скопировать все данные сервера БД на хосте
● зайти в mysql-cli и запустить SQL команду для проверки таблицы
● если таблица повреждена, необходимо ее восстановить
● в случае успешного восстановления, будет следующий вывод
Взято с сайта: digitalocean.com
```
##### 10
```bash
В основном проблемы с сокетным взаимодействием возникает
в случае:
● искажения конфигурационного файла сервера MySQL ;
● нарушения прав доступа до сокет-файла.
```
##### 11
```bash
Для выставления корректных прав доступа и проверки корректности
конфигурации:
● Определите местоположение в файловой системе файла сокета и
идентификатора процесса из конфигурационного файла
● Изучите права на директорию с этими файлами
● В случае некорректно выставленных прав, установите необходимые
Важно! Перед проведением данных процедур - необходима остановка
сервера БД.
Взято с сайта: digitalocean.com
```

#### PostgreSQL
##### 1
```bash
Типовые проблемы, возникающие при использовании PostgreSQL
схожи с MySQL:
● замедление выполнения пользовательских запросов;
● неверная настройка удаленного доступа к БД;
● нехватка серверных ресурсов;
● повреждение таблиц.
```
##### 2
```bash
Причины замедления пользовательских запросов описаны в slow_log,
аналогично MySQL. По умолчанию в PostgreSQL slow_log отключен.
Для включения slow_log необходимо в конфигурационном файле объявить
временную величину, дольше которой записи будут считаться slow и
записываться в log, например 5 секунд:
Также можно для каждой БД присвоить индивидуальную величину времени,
для записи в slow_log:
Пример записи в slow log:
Анализ причин замедления запроса можно провести, используя директиву
EXPLAIN
Взято с сайта: cybertec-postgresql.com
```
##### 3
```bash
Проблемы удаленного доступа чаще всего связаны со следующим:
● Доступ на фаерволе
Исправляется настройкой фаервола на хост-машине
● Некорректная привязка сервера БД к сетевому интерфейсу
● Некорректно указаны методы аутенфикации (в файле pg_hba.conf)
```
##### 4
```bash
Восстановление поврежденных таблиц является довольно
сложной и нетривиальной процедурой в рамках postgresql.
“Best-practice” для решения таких проблем - является регулярный
backup данных и тестирование этих backup. В случае
повреждения таблиц, всегда можно восстановиться из такого
backup и WAL.
Важно! Перед операциями восстановления - произведите
создание резервной копии данных на уровне файловой системы.
```

#### Elasticsearch
##### 1
```bash
Типовые проблемы, возникающие при использовании
Elasticseach:
● утечка памяти на уровне JVM ;
● отсутствие привязки индексов и шард.
```
##### 2
```bash
Профилирование - способ нахождения утечек памяти JVM.
Оптимальные показатели профилировки GC:
● графики имеют “пилообразный” характер;
● нет резких скачков потребления памяти - “climbing”;
● частота “пил” на графике - стремится к константе;
● значения потребления памяти не доходят до граничных,
установленных в Xms и Xmx.

Дан совет как устанавливать Elasiksearch
```
##### 3
```bash
Garbage Collector Logging
Пример настроек:
-XX:+PrintGCDetails;
-XX:+PrintGCDateStamps;
-Xloggc:/opt/app/gc.log.
В штатной работе - обычно логирование GC не используется.Elasticsearch
Пример профилировки с утечкой памяти
Взято с сайта: threeturves.blogspot.com/2009/08/how-to-ﬁnd-java-memory-leaks-part-1.htmlElasticsearch
Пример профилировки с штатной работой:
Взято с сайта: https://conﬂuence.atlassian.com/kb/how-to-deﬁne-xmx-based-on-gc-logs-960142303.htmlElasticsearch
В случае появления UNASSIGNED шард и индексов (например при
потере какой-либо ноды кластера), можно осуществить их
перепривязку к конкретной кластерной ноде, используя API.
Поиск шард в состоянии UNASSIGNED:
Ответное сообщение будет содержать:
Взято с сайта: datadoghq.com
```
##### 4
```bash
Вызов API для ручной
перепривязки индексов.
Взято с сайта: elastic.co
```

#### 46Итоги
##### 1
```bash
В рамках данной лекции мы рассмотрели типовые проблемы
с серверами БД:
● MongoDB ;
● Redis ;
● MySQL ;
● PostgreSQL ;
● Elasticsearch.
И узнали возможные пути решения этих проблем.
```
#### Домашнее задание
```bash
Давайте посмотрим ваше домашнее задание.
● Вопросы по домашней работе задавайте в чате мессенджера
Slack.
● Задачи можно сдавать по частям.
● Зачёт по домашней работе проставляется после того, как
приняты все задачи.
```
```bash
49Задавайте вопросы и
пишите отзыв о лекции!
Роман Гордиенко
Роман Гордиенко
---
Ссылки из лекции:
[1](https://bobcares.com/blog/troubleshoot-redis-latency-problems/)
[2](https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html)
[3](https://www.elastic.co/guide/en/elasticsearch/reference/7.15/rpm.html#rpm-repo)
[4](https://github.com/JoeDog/siege) - утилита для темтирования БД
